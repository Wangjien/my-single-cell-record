name: Deploy MkDocs to GitHub Pages

# 仅保留push触发+手动触发（删除PR触发，避免权限坑）
on:
  push:
    branches: [ master ]
  workflow_dispatch:  # 启用手动触发，方便调试

jobs:
  deploy:
    runs-on: ubuntu-latest
    # 关键：显式授予GITHUB_TOKEN推送权限
    permissions:
      contents: write  # 允许推送分支
      pages: write     # 允许操作Pages
      id-token: write

    steps:
      # 步骤1：拉取代码（需拉全历史，避免MkDocs编译异常）
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 必须：拉取所有提交历史

      # 步骤2：配置Python环境
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 步骤3：安装依赖（确保Material主题生效）
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material

      # 步骤4：部署（改用内置GITHUB_TOKEN，无需手动令牌）
      - name: Deploy to GitHub Pages
        run: mkdocs gh-deploy --force
        env:
          # 正确引用GitHub内置令牌（无需手动配置Secrets）
          GITHUB_TOKEN: SINGLECELL_TOKEN